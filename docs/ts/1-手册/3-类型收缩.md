---
tags:
    - ts
---

# 类型收缩

类型具体化旨在我们应当对联合类型细分后再进行具体类型的应用：

```ts
function padLeft(padding: number | string, input: string) {
    // 括号内的语句被 TS 称为 'type guard'，即"类型保护"
    if (typeof padding === 'number') {
        // 这里 TS 会分析出 `padding` 是 `number` 类型
        return new Array(padding + 1).join(' ') + input;
    }
    // 这里 TS 会分析出 `padding` 是 `string` 类型
    return padding + input;
}
```

这种类型检查特性会存在于各种控制流语句上，比如 `if-else`、三元条件语句、循环、真值检查等等。

## `typeof` 中的类型保护

`typeof` 是 JS 里的操作符，能够再运行时里提供值类型信息。TS 能够分析的 `typeof` 的返回值有：

    "string" | "number" | "bigint" | "boolean" | "undefined" | "object" | "function"

TS 有着自己的 `typeof` 处理，因为 JavaScript 中可能会存在一些奇怪的行为，比如 `null` 会被认为是 `object` 类型（实际上 `null` 自身是一种类型）：

```ts
function printAll(strs: string | string[] | null) {
    if (typeof strs === 'object') {
        // ERROR: 这里的 `strs` 也有可能是 `null`
        for (const s of strs) {
            console.log(s);
        }
    } else if (typeof strs === 'string') {
        // ...
    }
}
```

## 真值检查

在 JS 里我们可以在条件语句、`&&`、`||`、`if` 语句或否定符 `!` 等里使用任何表达式。比如我们可以在 `if` 里放非 `boolean` 类型的条件语句。JS 会将条件语句强制转为布尔值，比如这些值会被转为 `false` ：

-   0

-   NaN

-   "" ，即空字符串

-   0n ，即 `bigint` 中的 0

-   `null`

-   `undefined`

你也可以用 `Boolean` 函数将值转为布尔值，或者用双否定 `!!` 。而后者其实会推断为一个布尔值字面量类型（比如例子中为 `true` ），前者仅仅是个 `boolean` 类型：

```ts
Boolean('hello'); // 类型为 `boolean` ，值为 `true`
!!'world'; // 类型和值均为 `true`
```

我们可以利用这一行为来进行空值检查：

```ts {2}
function printAll(strs: string | string[] | null) {
    if (strs && typeof strs === 'object') {
        for (const s of strs) {
            console.log(s);
        }
    } else if (typeof strs === 'string') {
        // ...
    }
}
```

但是 **不要** 写成如下的例子，因为空字符串是 `string` 类型，但是会转为布尔值 `false` ：

```ts {2}
function printAll(strs: string | string[] | null) {
    if (strs) {
        if (typeof strs === 'object') {
            for (const s of strs) {
                console.log(s);
            }
        } else if (typeof strs === 'string') {
            // ...
        }
    }
}
```

## 参考

[Narrowing - TypeScript](https://www.typescriptlang.org/docs/handbook/2/narrowing.html)
