# 需求：短链服务

## 功能概要

需要做一个短链服务及页面，可以将长链接转换为短链接，并且可以通过短链接访问对应的长链接。支持：

-   生成随机的哈希值作为短链标识
-   支持自定义短链标识

## 【已完成】任务一

请先学习一下这个项目的后端部分里 luoye 的请求及响应格式规范。并将结果写 `memo/接口规范.md`。内容尽量保证精准简短。

## 【已完成】任务二

请基于当前项目结构及 `memo/接口规范.md` ，设计一个短链服务的后端部分（暂不实现）。

**后端设计已完成**，详见接口文档：`src/pages/api-doc/shortcut.md`

## 【已完成】任务三

请实现接口文档中的 POST 创建短链接口。相关代码规范可以借鉴 luoye 和 `memo/接口规范.md` 。

> 完成任务后，请在下方填写总结，总结内容请精准简短，并将任务标题置为【已完成】。

### 总结

已完成 POST 创建短链接口实现：

1. **文件创建**：`server/routes/shortcut.js` - 实现短链服务路由
2. **路由注册**：在 `server/index.js` 中注册 `/shortcut` 路由
3. **目录初始化**：在 `server/config.js` 中添加 `shortcuts` 目录初始化
4. **核心功能**：
    - 支持随机生成 6 位短链 ID
    - 支持自定义短链 ID（3-20 位字母/数字/下划线/中划线）
    - URL 格式验证
    - 短链 ID 唯一性检查
    - 仅管理员可创建（使用 `adminLogin` 中间件）
    - 数据存储在 `shortcuts/list.json` 文件
5. **错误处理**：遵循项目规范，包含英文和中文错误消息

## 【已完成】任务四

现在需要对网关及根路由做一些改造。当前的 nginx 配置如下：

```nginx
hidden
```

现在我想让短链以 `/s/短链标识` 的形式访问到对应的长链接。请帮我修改上述 nginx 配置，并说明修改内容。同时按需修改后端路由。

> 完成任务后，请在下方填写总结，总结内容请精准简短，并将任务标题置为【已完成】。

### 修改内容

**nginx 配置修改**（在 `location /api/` 之前添加）：

```nginx
# 短链服务重定向
location /s/ {
    proxy_pass http://localhost:4000/shortcut/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

**修改说明**：

1. 添加 `/s/` location 块，拦截所有短链请求
2. 将请求代理到后端服务 `http://localhost:4000/shortcut/`
3. 保留原始请求头信息（Host、IP 等）

**后端路由修改**（已完成）：

-   在 `server/routes/shortcut.js` 中添加了 `GET /:shortcutId` 接口
-   功能：查询短链、更新访问统计、执行 302 重定向
-   访问路径：`/s/abc123` → nginx 代理 → `/shortcut/abc123` → 重定向到原始 URL

### 总结

已完成短链服务重定向功能：

1. **后端实现**：添加 `GET /:shortcutId` 接口，支持短链查询和重定向
2. **访问统计**：记录访问次数和最后访问时间
3. **nginx 配置**：添加 `/s/` location 块，代理请求至 `/shortcut/` 路由
4. **访问流程**：用户访问 `/s/abc123` → nginx 转发到后端 → 后端执行 302 重定向到原始链接

## 【已完成】任务五

请写一下接口对应的测试代码，测试代码怎么写可以参考 luoye 。

> 完成任务后，请在下方填写总结，总结内容请精准简短，并将任务标题置为【已完成】。

### 总结

已完成短链服务测试代码：

1. **测试文件**：`server/__tests__/shortcut.js`
2. **测试覆盖**：
    - **创建短链**：随机 ID、自定义 ID、缺省 name、参数验证（必填项、URL 格式、ID 格式、ID 长度、重复 ID）、权限验证
    - **访问短链**：随机 ID 重定向、自定义 ID 重定向、不存在的短链、多次访问统计
3. **测试工具**：使用 `Rocket`（HTTP 客户端）和 `TestCase`（测试用例管理器）
4. **测试注册**：在 `server/__tests__/index.js` 中注册短链测试
5. **测试规范**：遵循 luoye 测试结构，包含正向测试（`pos`）和负向测试（`neg`）

**注意**：重定向测试由于 302 状态码会导致跨域问题，实际验证需要后续添加 `GET /:shortcutId/info` 接口来查询短链详细信息和访问统计。

## 【已完成】任务六

添加管理员查看短链信息的后台接口，方便管理和统计。

> 完成任务后，请在下方填写总结，总结内容请精准简短，并将任务标题置为【已完成】。

### 总结

已完成管理员后台接口：

1. **接口文档更新**：在 `src/pages/api-doc/shortcut.md` 中新增两个管理接口
    - `GET /list`：获取所有短链列表，按创建时间倒序排列
    - `GET /info/:shortcutId`：获取单个短链详情（不增加访问计数）
2. **后端实现**：在 `server/routes/shortcut.js` 中实现两个接口
    - 仅管理员可访问（使用 `adminLogin` 中间件）
    - 包含完整的访问统计数据（visits、lastVisit）
3. **测试覆盖**：在 `server/__tests__/shortcut.js` 中新增测试用例
    - 正向测试：获取列表、获取详情、验证排序、验证访问统计
    - 负向测试：未找到短链、未授权访问
4. **功能特性**：
    - 列表按创建时间倒序排列，方便查看最新短链
    - 详情接口不会增加访问计数，避免影响统计数据
    - 完善了之前测试中的 TODO 项，可通过 `/info/:shortcutId` 验证访问统计

## 【已完成】任务七

请完成剩余接口开发，并完成对应的测试代码。

> 完成任务后，请在下方填写总结,总结内容请精准简短，并将任务标题置为【已完成】。

### 总结

已完成剩余接口开发及测试：

1. **PUT 更新短链接口**：`PUT /:shortcutId`
    - 支持更新 `url` 和 `name` 字段
    - 支持单独更新任一字段或同时更新
    - 支持清空 `name` 字段（传空字符串）
    - URL 格式验证
    - 仅管理员可访问
2. **DELETE 删除短链接口**：`DELETE /:shortcutId`
    - 根据短链 ID 删除指定短链
    - 返回删除成功标识
    - 仅管理员可访问
3. **测试覆盖**：在 `server/__tests__/shortcut.js` 中新增测试
    - **PUT 测试**：单独更新 url、单独更新 name、同时更新、清空 name、短链不存在、空 URL、无效 URL、未授权访问
    - **DELETE 测试**：成功删除、验证已删除、短链不存在、未授权访问
    - 测试数据清理：删除测试过程中创建的短链

**功能特性**：

-   更新接口不支持修改短链标识 `id`（符合需求）
-   更新时仅修改传入的字段，未传入字段保持原值
-   完整的参数验证和错误处理
-   所有管理接口均使用 `adminLogin` 中间件保护

### 【已完成】任务八

请你写一个简单的后台管理页面。要求不多：

1. 尽量使用 'src/components' 目录下已有的组件。
2. 表单样式可以仿照 Weaver 中的表单。
3. 删除操作需要有 confirm 确认弹窗。
4. 代码写在 'src/pages/shortcut.tsx' 文件中。

> 完成任务后，请在下方填写总结，总结内容请精准简短，并将任务标题置为【已完成】。

### 总结

已完成短链后台管理页面：

1. **API 层**：创建 `src/api/shortcut.ts`，实现所有短链接口调用
    - 列表查询、详情查询、创建、更新、删除
    - 在 `src/api/index.ts` 中注册 `shortcut` API
2. **主页面**：`src/pages/shortcut.tsx`
    - 表格展示所有短链，包含短链标识、名称、目标链接、访问统计、时间信息
    - 复制短链功能（点击 📋 图标）
    - 新建、编辑、删除操作
    - 使用 `useUserEntry` Hook 进行用户认证
3. **表单组件**：`src/pages/components/ShortcutForm.tsx`
    - 支持新建和编辑两种模式
    - 新建时支持自定义短链标识（可选）
    - 使用 Portal 渲染模态框
    - 复用项目中的 `Button` 和 `Input` 组件
4. **样式文件**：
    - `shortcut.module.css`：主页面样式，响应式表格设计
    - `ShortcutForm.module.css`：表单样式，参考 Weaver 表单设计
5. **功能特性**：
    - ✅ 使用现有 Form 组件（Button、Input）
    - ✅ 表单样式仿照 Weaver（模态框、表单布局）
    - ✅ 删除操作有 confirm 确认弹窗
    - ✅ 响应式设计，支持移动端
    - ✅ 一键复制短链到剪贴板
    - ✅ 链接可点击跳转预览
