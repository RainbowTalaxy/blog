# 后端接口规范

## 请求格式

### 认证方式

-   **Cookie**: 使用 JWT token 存储在 `token` cookie 中
-   **中间件**:
    -   `login`: 强制登录，未登录返回 401
    -   `weakLogin`: 可选登录，未登录不拦截
    -   `adminLogin`: 管理员权限，非管理员返回 403

### 请求参数

-   **路径参数**: 通过 `req.params` 获取，如 `/workspace/:workspaceId`
-   **查询参数**: 通过 `req.query` 获取
-   **请求体**: 通过 `req.body` 获取（JSON 格式）

### 参数校验

-   必填参数缺失时返回 400 状态码
-   参数格式错误时返回 400 状态码
-   使用双语错误消息：`error`（英文）和 `message`（中文）

## 响应格式

### 成功响应

-   **状态码**: 200（默认）
-   **响应体**:
    -   直接返回数据对象：`res.send(data)`
    -   或简单成功对象：`res.send({ success: true })`

### 错误响应

#### 客户端错误（4xx）

| 状态码 | 场景               | 示例                                                             |
| ------ | ------------------ | ---------------------------------------------------------------- |
| 400    | 参数缺失或格式错误 | `{ error: '`name` is required', message: '工作区名称不能为空' }` |
| 401    | 未登录或登录过期   | `{ error: 'Please login first', message: '请先登录' }`           |
| 403    | 无权限访问         | `{ error: 'Forbidden', message: '无权限' }`                      |
| 404    | 资源不存在         | `{ error: 'workspace not found', message: '未找到工作区' }`      |

#### 服务器错误（5xx）

-   **状态码**: 500
-   **响应体**: `{ error: 'Internal Server Error', message: '服务器错误' }`
-   **错误传递**:
    -   在路由中设置 `res.error` 和 `res.message`
    -   通过 `next(error)` 传递给错误处理中间件
    -   统一在 `server/index.js` 中的错误处理中间件处理

### 错误消息规范

-   `error`: 英文错误描述，使用反引号包裹参数名（如 `` `workspaceId` ``）
-   `message`: 中文错误描述，用于前端展示
-   常量定义在 `constants.js` 的 `ErrorMessage` 类中

## 权限控制

### 访问范围（Scope）

-   `Private`: 私有，仅创建者可见
-   `Public`: 公开，所有人可见

### 访问级别（Access）

| 级别      | 值  | 说明                   |
| --------- | --- | ---------------------- |
| Forbidden | 0   | 禁止访问               |
| Visitor   | 10  | 访客（仅查看公开内容） |
| Member    | 50  | 成员                   |
| Admin     | 100 | 管理员（创建者）       |

### 权限判断

-   通过 `LuoyeUtl.access(resource, userId)` 判断用户权限级别
-   访客权限会过滤私有内容（`LuoyeUtl.filterPrivate()`）
-   管理员权限才能修改/删除资源

## 接口命名规范

### RESTful 风格

-   `GET /resource`: 获取资源列表
-   `GET /resource/:id`: 获取单个资源
-   `POST /resource`: 创建资源
-   `PUT /resource/:id`: 更新资源
-   `DELETE /resource/:id`: 删除资源

### 示例

```javascript
// 获取工作区列表
GET /luoye/workspaces

// 获取单个工作区
GET /luoye/workspace/:workspaceId

// 创建工作区
POST /luoye/workspace

// 更新工作区
PUT /luoye/workspace/:workspaceId

// 删除工作区
DELETE /luoye/workspace/:workspaceId
```
